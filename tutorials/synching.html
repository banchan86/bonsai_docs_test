<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Data Synchronization </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Data Synchronization ">
      
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/bonsai-rx/docs/blob/main/tutorials/synching.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="data-synchronization">Data Synchronization</h1>

<p>Synchronizing behaviour and other experimental events with stimulation or recorded neural data is a fundamental component of neuroscience data collection and analysis. The exercises below will walk you through some common synchronization problems encountered in systems neuroscience experiments, and how to handle them using Bonsai.</p>
<h3 id="exercise-1-synchronizing-video-from-two-webcams"><strong>Exercise 1:</strong> Synchronizing video from two webcams</h3>
<div class="workflow"><p><img src="../workflows/synching-camera.bonsai" alt="Synching Video"></p>
</div>
<ul>
<li>Insert a <code>CameraCapture</code> source and set it to index 0.</li>
<li>Insert another <code>CameraCapture</code> source and set it to index 1.</li>
<li>Combine both sources using a <code>WithLatestFrom</code> combinator.</li>
<li>Insert a <code>Concat (Dsp)</code> operator and set its <code>Axis</code> property to 1.</li>
<li>Insert a <code>VideoWriter</code> sink and record a small segment of video.</li>
</ul>
<p><em>How would you test the synchronization between the two video streams?</em></p>
<div class="NOTE">
<h5>Note</h5>
<p>You can use the <code>FileCapture</code> source to inspect the video frame by frame by setting the <code>Playing</code> property to <code>False</code>. After setting the <code>FileName</code> property to match your recorded video, run the workflow, open the source visualizer, and then right-clicking on top of the video frame to open up the seek bar at the bottom. You can use the arrow keys to move forward and back on individual frames.</p>
</div>
<h2 id="reaction-time">Reaction Time</h2>
<p>For this and subsequent tutorials, we will use a simple reaction time task as our model systems neuroscience experiment. In this task, the subject needs to press a button as fast as possible following a stimulus, as described in the following diagram:</p>
<div class="diagram"><p><img src="../images/reactiontime.svg" alt="State Machine Diagram"></p>
</div>
<p>The task begins with an inter-trial interval (<code>ITI</code>), followed by stimulus presentation (<code>ON</code>). After stimulus onset, advancement to the next state can happen only when the subject presses the button (<code>success</code>) or a timeout elapses (<code>miss</code>). Depending on which event is triggered first, the task advances either to the <code>Reward</code> state, or <code>Fail</code> state. At the end, the task goes back to the beginning of the ITI state for the next trial.</p>
<h3 id="exercise-2-generating-a-fixed-interval-stimulus"><strong>Exercise 2:</strong> Generating a fixed-interval stimulus</h3>
<p>In this first exercise, you will assemble the basic hardware and software components required to implement the reaction time task. The wiring diagram below illustrates the hardware assembly. You can wire the LED into any digital input pin, but make sure to note the pin number for the steps below.</p>
<p><img src="../images/reactiontime-circuit.png" height="300" alt="Reaction Time Circuit"></p>
<p>We will start by using a fixed-interval blinking LED as our stimulus.</p>
<div class="workflow"><p><img src="../workflows/reactiontime-arduino.bonsai" alt="Create Arduino"></p>
</div>
<ul>
<li>To configure the Arduino analog sampling rate, insert a <code>CreateArduino</code> source.</li>
<li>Configure the <code>PortName</code> to the Arduino port where the microcontroller is connected.</li>
<li>Configure the <code>SamplingInterval</code> property to 10 ms.</li>
</ul>
<div class="workflow"><p><img src="../workflows/reactiontime-stimulus.bonsai" alt="Reaction Time Stimulus"></p>
</div>
<ul>
<li>Insert a <code>Timer</code> source and set its <code>DueTime</code> property to 1 second.</li>
<li>Insert a <code>Boolean</code> source and set its <code>Value</code> property to <code>True</code>.</li>
<li>Insert a <code>DigitalOutput</code> sink and set its <code>Pin</code> property to the Arduino pin where the LED is connected.</li>
<li>Configure the <code>PortName</code> to the Arduino port where the microcontroller is connected.</li>
<li>Insert a <code>Delay</code> operator and set its <code>DueTime</code> property to 200 milliseconds.</li>
<li>Insert a <code>Boolean</code> source and set its <code>Value</code> property to <code>False</code>.</li>
<li>Insert a <code>DigitalOutput</code> sink configured to the same <code>Pin</code> and <code>PortName</code>.</li>
<li>Insert a <code>Repeat</code> operator.</li>
</ul>
<h3 id="exercise-3-measuring-reaction-time"><strong>Exercise 3:</strong> Measuring reaction time</h3>
<div class="workflow"><p><img src="../workflows/reactiontime-measurement.bonsai" alt="Reaction Time Measurement"></p>
</div>
<ul>
<li>Insert an <code>AnalogInput</code> source.</li>
<li>Set the <code>Pin</code> property to the analog pin number where the duplicate LED wire is connected.</li>
<li>Insert a second <code>AnalogInput</code> source.</li>
<li>Set the <code>Pin</code> property to the analog pin number where the button is connected.</li>
<li>Connect both inputs to a <code>Zip</code> operator.</li>
<li>Insert a <code>CsvWriter</code> sink and configure the <code>FileName</code> property.</li>
<li>Insert a <code>RollingGraph</code> visualizer and set its <code>Capacity</code> property to 1000.</li>
<li>Run the workflow, and verify that both the stimulus and the button are correctly recorded.</li>
</ul>
<h3 id="exercise-4-synchronizing-video-with-a-visual-stimulus"><strong>Exercise 4:</strong> Synchronizing video with a visual stimulus</h3>
<p>To analyze movement dynamics in the reaction time task, you will need to align individual frame timing to stimulus onset. To do this, you can take advantage of the fact that our simple visual stimulus can be seen in the camera image and recorded together with the behaviour.</p>
<div class="workflow"><p><img src="../workflows/synching-led.bonsai" alt="Synching LED"></p>
</div>
<ul>
<li>Starting from the workflow in the previous exercise, insert a <code>CameraCapture</code> source and position the camera such that you can see clearly both the LED and the computer keyboard.</li>
<li>Insert a <code>VideoWriter</code> sink and configure the <code>FileName</code> with a path ending in <code>.avi</code>.</li>
<li>Insert a <code>Crop</code> transform and set the <code>RegionOfInterest</code> property to a small area around the LED.</li>
<li>Insert a <code>Grayscale</code> transform.</li>
<li>Insert a <code>Sum (Dsp)</code> transform. This operator will sum the brightness values of all the pixels in the input image.</li>
<li>Select the <code>Scalar</code> &gt; <code>Val0</code> field from the right-click context menu.</li>
<li>Record the output in a text file using a <code>CsvWriter</code> sink.</li>
<li>Open both the text file containing the Arduino data, and the text file containing video data, and verify that you have detected an equal number of stimulus in both files. What can you conclude from these two pieces of data?</li>
<li><strong>Optional:</strong> Open the raw video file and find the exact frame where the stimulus came on. If you compare different trials you might notice that the brightness of the LED in that first frame across two different trials is different. Why is that?</li>
</ul>
<h3 id="exercise-5-trigger-a-visual-stimulus-using-a-button"><strong>Exercise 5:</strong> Trigger a visual stimulus using a button</h3>
<p>To make our task more interesting, we will now trigger the stimulus manually using a button press and learn more about <code>SelectMany</code> along the way!</p>
<div class="workflow"><p><img src="../workflows/reactiontime-triggerstimulus.bonsai" alt="Triggered Stimulus Outer"></p>
</div>
<ul>
<li>Connect a new push button component into one of the Arduino digital inputs.</li>
<li>Insert a <code>DigitalInput</code> source and set its <code>Pin</code> property to the Arduino pin where the new button is connected.</li>
<li>Configure the <code>PortName</code> to the Arduino port where the microcontroller is connected.</li>
<li>Insert a <code>Condition</code> operator.</li>
<li>Insert a <code>SelectMany</code> operator and move the stimulus generation logic inside the nested node:</li>
</ul>
<div class="workflow"><p><img src="../workflows/reactiontime-triggerstimulus-inner.bonsai" alt="Triggered Stimulus Inner"></p>
</div>
<p><em>Why do we need to remove the <code>Repeat</code> operator?</em></p>
<ul>
<li>Ask a friend to test your reaction time!</li>
<li><strong>Optional:</strong> In the current workflow, what happens if you press the stimulus button twice in succession? Can you fix the current behaviour by using one of the higher-order operators?</li>
</ul>
<h3 id="exercise-6-recording-response-triggered-videos"><strong>Exercise 6:</strong> Recording response-triggered videos</h3>
<div class="workflow"><p><img src="../workflows/reactiontime-triggervideo.bonsai" alt="Triggered Video Outer"></p>
</div>
<ul>
<li>Starting from the previous workflow, insert another <code>AnalogInput</code> source with the <code>Pin</code> property set to the button press pin number.</li>
<li>Insert a <code>GreaterThan</code> operator.</li>
<li>Insert a <code>DistinctUntilChanged</code> operator.</li>
<li>Insert a <code>Condition</code> operator.</li>
<li>In a new branch coming off the <code>VideoWriter</code>, insert a <code>Delay</code> operator.</li>
<li>Set the <code>DueTime</code> property of the <code>Delay</code> operator to 1 second.</li>
<li>Insert a <code>TriggeredWindow</code> operator, and set its <code>Count</code> property to 100.</li>
<li>Insert a <code>SelectMany</code> operator and inside the nested node create the below workflow:</li>
</ul>
<div class="workflow"><p><img src="../workflows/reactiontime-triggervideo-inner.bonsai" alt="Triggered Video Inner"></p>
</div>
<ul>
<li>Run the workflow and record a few videos triggered on the button press.</li>
<li>Inspect the videos frame by frame and check whether the response LED comes ON at exactly the same frame number across different trials.</li>
<li>If it does not, why would this happen? And how would you fix it?</li>
</ul>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/bonsai-rx/docs/blob/main/tutorials/synching.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          &copy; 2024 Bonsai Foundation CIC and Contributors. Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>. Made with <a href="https://dotnet.github.io/docfx">docfx</a>
        </div>
      </div>
    </footer>
  </body>
</html>

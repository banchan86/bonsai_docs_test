# Documentation With Docfx

Effective online documentation plays a crucial role in driving the adoption and usage of custom packages. For packages published by the Bonsai Foundation, we use [docfx](https://dotnet.github.io/docfx/index.html), a static site generator for .NET projects, to automatically generate and publish documentation online. As we have integrated and extended `docfx` to facilitate key Bonsai features, we encourage package developers to use `docfx` for consistency and support within the Bonsai Ecosystem. 

The following article will go into how to create a `docfx` website for your package. For documentation style guidelines, check out the [Documentation Style Guide](./documentation-style-guide.md).

> [!TIP]
> We recommend using a code editor with an integrated terminal like [Visual Studio Code](https://code.visualstudio.com/) to follow along with these instructions.

## Repository organization
For effective long term maintenance of documentation across different repositories, package repositories should be organised according to this standardized folder structure before setting up `docfx`: 

```
.
├── .bonsai/                 # Local Bonsai Environment (see note below) 
├── .github/workflows/       # Github Actions Folder (see note below) 
│   └── docs.yml
├── docs/                    # Folder to setup docfx
└── src/
    └── Bonsai.PackageName/  # Project files here
... 
```

- `.bonsai/` - A local Bonsai [environment](https://bonsai-rx.org/docs/articles/environments.html) is required for a script that exports Bonsai workflow images. To create one run these following commands:

```powershell
dotnet new install Bonsai.Templates
dotnet new bonsaienv
```

- `.github/workflows/` - The docfx website is published to [Github Pages](https://pages.github.com/) using a [Github Actions](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions) workflow called `docs.yml`. Download this folder from the [docfx-assets](https://github.com/bonsai-rx/docfx-assets) repository and amend `Bonsai.PackageName` to point to your package source code in `docs.yml`.

## Setting up docfx

1) Setup a local installation of `docfx` in your package repository with the following commands (executed in the root directory):

```powershell
dotnet new tool-manifest 
dotnet tool install --local docfx 
```

2) Navigate to the `docs` folder and initialise a new docfx website with the following command.

```powershell
dotnet docfx init 
```

3) Select these options for the new website.

```powershell
Name (mysite): Bonsai - Package Name
Generate .NET API documentation? [y/n] (y): y
.NET projects location (src): src
Markdown docs location (docs): articles
Enable site search? [y/n] (y): y
Enable PDF? [y/n] (y): n
```

Congrats! You now have a minimal `docfx` website. Run the following command to generate a local preview of the website, and verify that API documentation for your package has been generated successfully:

```powershell
dotnet docfx docfx.json --serve
```

### Docfx folder organization

Before proceeding further into configuring the `docfx` website, the `docs` folder should be organised according to this layout for effective long term maintenance. 

```
.
├── api/                     # Automatically generated by docfx
├── apidoc/                  # Place individual operator articles here (see style guide)
├── articles/                # Place "Manual" section articles here (see style guide) 
├── bonsai/                  # Docfx-tools submodule (see note below)
├── images/                  # Place images like screenshots here
├── template/                # Custom CSS template (see note below)
│   └── public/
│       ├── main.css
│       └── main.js
├── tutorial/                # Place "Tutorials" section articles here (see style guide)   
├── workflow/                # Place .bonsai workflow files here for image export
├── build.ps1                # Bonsai workflow image export script (see note below)
├── logo.svg                 # Website logo
└── favicon.ico              # Website bookmark logo
...
```

- `bonsai/` - this folder is where we place a submodule that we have created called [docfx-tools](https://github.com/bonsai-rx/docfx-tools). This submodule contains scripts for automating image export from `Bonsai` workflows (if you want to include them in your article) and adds a CSS template for `Bonsai` workflow containers (these containers allow users to easily copy workflows into the `Bonsai` editor). To add it, run this command in the `docs` folder:

```powershell
git submodule add https://github.com/bonsai-rx/docfx-tools bonsai
```
If you cloned the repository and the `bonsai` folder does not contain any files:

```powershell
git submodule update --init
```

To update the submodule to the latest commit:
```powershell
git submodule update --remote
```

- `template/` - this custom CSS template patches in docfx-tools and adds a github link to the top right of the navigation bar. Download this folder from the [docfx-assets](https://github.com/bonsai-rx/docfx-assets) repository and amend the github link in `main.css` to your repository.

- `build.ps1` - this custom script exports bonsai workflow as images the workflow container. Download the file from the [docfx-assets](https://github.com/bonsai-rx/docfx-assets) repository and amend the line that specifies the package name and source location.

- `logo.svg` and `favicon.ico` - for official Bonsai packages these can be downloaded from the [docfx-assets](https://github.com/bonsai-rx/docfx-assets) repository.


### Configuring docfx

The `docfx.json` file in the `docs` folder hosts the configuration options for the website and needs to be modified to fully utilize the features availiable. If in doubt, refer to a Bonsai package repository that has been recently updated (for instance https://bonsai-rx.org/machinelearning/) or the [docfx documentation](https://dotnet.github.io/docfx/) for more information. These steps are listed in order of appearance in `docfx.json`.

1) Add a `filter` attribute to [filter](https://dotnet.github.io/docfx/docs/dotnet-api-docs.html#filter-apis) obsolete operators in the package. In the process of upgrading packages we want to avoid documenting operators that are no longer supported (but are still included for compatibility purposes for old workflows). You can also hide private classes that are not supposed to be shown to the end user. 

```yml
"metadata": [
    {
        "filter": "filter.yml"
    }
]
```

Make a file called `filter.yml` with the following lines and place in the `docs` directory. You can also specify other [uids](https://dotnet.github.io/docfx/docs/dotnet-api-docs.html#filter-apis) here.

```yml
apiRules:
- exclude:
    hasAttribute:
      uid: System.ObsoleteAttribute
```

2) Exclude these files from being included in the building of content to avoid duplicate errors.

```json
"build": {
    "content": [
        "exclude": [
            "_site/**",
            "filter.yml",
            "apidoc/**"
        ]
    ]
}
```

3) Add the `overwrite` attribute to enable [individual operator articles](./documentation-style-guide.md) stored in the `apidocs` folder to be included in articles and API docs.

```json
"build": {
    "overwrite": [
      {
        "files": [
          "apidoc/**.md"
        ],
        "exclude": [
          "obj/**",
          "_site/**"
        ]
      }
    ],
}
```

4) Modify the `resource` attribute to include files that need to be imported.

```json
"resource": {
    "files": [
        "logo.svg",
        "favicon.ico",
        "images/**",
        "workflows/**"
    ]
}
```

5) Modify the `template` attribute to use the modern template and apply the `docfx-tools` custom templates to enable workflow containers.

```json
"template": [
    "default",
    "modern",
    "bonsai/template",
    "template"
]
```

6) Modify the `globalMetadata` attribute to change package name and add the `_appFooter` attribute and description.

```json
"globalMetadata": {
    "_appName": "Bonsai - PackageName",
    "_appTitle": "Bonsai.PackageName",
    "_appFooter": "&copy; 2024 Bonsai Foundation CIC and Contributors. Made with <a href=\"https://dotnet.github.io/docfx\">docfx</a>"
}
```

7) Add the `markdownEngineProperties` attribute to enable [markdig](https://github.com/xoofx/markdig)(DocFX markdown processor) extensions for additional markdown functionality. 

```json
"build": {
    "markdownEngineProperties": {
        "markdigExtensions": [
        "attributes",
        "customcontainers"
        ]
    }
}
```

8) Add the `xref` attribute to cross reference classes from the Bonsai library (if you use them to build your package). If you have used other libraries with docfx documentation, add their `xrefmap.yml` here as well.

```json
"build": {
    "xref": [
        "https://bonsai-rx.org/docs/xrefmap.yml",
    ]
}
```

## Publishing to Github Pages

Once you are satisfied with the website, publish to [Github Pages](https://docs.github.com/en/pages/getting-started-with-github-pages/creating-a-github-pages-site). A Github Actions workflow has already been created, make sure `docs.yml` is in the `.github/workflows` [folder](#repository-organization).

1) Setup a new branch called `gh-pages` on your fork of the repository.
2) Go to your repo settings -> `Pages` -> `Build and deployment` - under `Source` select `Deploy from a branch` and make sure `gh-pages` is selected.
3) Commit your edits and push them online.
4) Under the `Actions` tab of your github repo, trigger the `Build docs` workflow manually with the `Run workflow` button on the branch you commited your edits to. This will build the docs site on the `gh-pages` branch.
5) Once the `Build docs` workflow has been completed, the `pages-build-deployment` workflow will run and publish your forked repo automatically.
7) The URL for the site can be found in your `Pages` section of your repo settings.

## Version control cleanup
To keep your online Github repository clean, you can use .gitignore files to ignore files that are generated for documentation that do not need to be version controlled. Add each item as a separate line to the appropriate .gitignore file in each location.

```
.
├── .bonsai/
│   └── .gitignore           # Packages, *.exe, *.exe.settings, *.exe.old (local environment files regenerated by Setup.cmd)
└── docs/
    ├── api/
    │   └── .gitignore       # *.yml, .manifest (docfx automatically generated files)
    ├── workflows/
    │   └── .gitignore       # *.layout, *.svg (bonsai workflow layout files and locally generated images)
    └── .gitignore           # _site (folder generated by docfx for local preview)
...
```

## Testing unpublished packages

To write documentation for [new packages or releases](https://bonsai-rx.org/docs/articles/create-package.html) that have not been published to the community, test them in Visual Studio. 

1) Install [Visual Studio](https://www.visualstudio.com/) (the community edition can be installed for free).
2) Install Bonsai VS Extensions. Assuming Bonsai is already installed, from the Windows Start Menu, search for the "Install Bonsai VS Extensions" shortcut and run it.
3) In Visual Studio, open `src/PackageName.sln` in the repo.
4) Press F5 to open the Bonsai editor with the new package added. 
5) From here, you can make Bonsai workflows and save them as per normal.


## Troubleshooting

### File not found errors

These are usually due to folders not being in the right place, check the directory trees above or a repository that has been recently updated (for instance https://bonsai-rx.org/machinelearning/) for reference. Also pay attention to any scripts/css files that require modification of the package name/link/source location.

### Docfx local preview not updating 

If you are running the local preview `dotnet docfx docfx.json --serve` and not seeing changes:

1) Make sure that any changes you have made in your code editor are saved.
2) Hard refresh pages in the browser using either Ctrl+Shift+R and Ctrl+F5 or clear the cache to avoid cache issues.
3) As a last resort - check that the content updates online by [publishing your website](#publishing-to-github-pages).

### Differences between local and online builds

If there are discrepancies between local and online builds and they persist, this could indicate a docfx version conflict. The online build process uses a local installation of `docfx` but it is also possible to install `docfx` globally (which we do not recommend). To check if this is the cause of the discrepancy:

Make sure to run this command which uses the local installation of `docfx`
```powershell
dotnet docfx docfx.json --serve
```

Instead of this command which uses the global installation of `docfx`.
```powershell
docfx docfx.json --serve
```
The `.config` folder in the root directory contains `docfx` local version info if you need to check it.

If you wish to update the local installation of docfx run this command in the root directory:

```powershell
dotnet tool update docfx
```




# Documentation With Docfx
Effective documentation plays a crucial role in driving the adoption and usage of custom packages. Clear, well-organized documentation helps users understand package functionality, integrate it into their workflows, and troubleshoot issues. 

For packages published by the Bonsai Foundation, we use [docfx](https://dotnet.github.io/docfx/index.html), a static site generator for .NET projects, to automatically generate and publish documentation online. As we have integrated and extended `docfx` to support key Bonsai features, we encourage using `docfx` for consistency and support within the Bonsai Ecosystem. The following article will go into how to create a `docfx` website for your package.

> [!TIP]
> We recommend using a code editor with an integrated terminal like [Visual Studio Code](https://code.visualstudio.com/) to follow along with these instructions.

## Repository organization
For effective long term maintenance of documentation across different repos, package repos should be organised according to this standardized folder structure: 
```
.
├── .bonsai                 # See note below    
├── .github/workflows       # See note below   
│   └── build.yml
├── docs                    # Folder to setup docfx
└── src
    └── Bonsai.PackageName  # Project files here
... 
```

- `.bonsai` - A local Bonsai [environment](https://bonsai-rx.org/docs/articles/environments.html) is required for a script that exports Bonsai workflow images. To create one:

```powershell
dotnet new install Bonsai.Templates
dotnet new bonsaienv
```

- `.github/workflows` - The docfx website is published to [Github Pages](https://pages.github.com/) using a [Github Actions](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions) recipe named [build.yml](https://github.com/bonsai-rx/docs/blob/main/.github/workflows/build.yml).  Download `build.yml` and place it in this folder.

Now that your repository is organized, you can move on to setup docfx.

## Setting up docfx

1) Setup a local installation of `docfx` in your package repo with the following commands (executed in the root directory):
```powershell
dotnet new tool-manifest 
dotnet tool install --local docfx 
```
This should create a `.config` folder in the root directory that contains `docfx` version info.

2) Navigate to the `docs` folder and initialise a new DocFx website with the following command.

```powershell
dotnet docfx init 
```

3) Select these options for the new website.

```powershell
Name (mysite): Bonsai - Package Name
Generate .NET API documentation? [y/n] (y): y
.NET projects location (src): src
Markdown docs location (docs): articles
Enable site search? [y/n] (y): y
Enable PDF? [y/n] (y): n
```

Congrats, you now have a minimal `docfx` website. Run the following command to generate a local preview of the website, and verify that API documentation for your package has been generated successfully:

```powershell
dotnet docfx docfx.json --serve
```

### Docfx folder organization

Before proceeding further into customizing the `docfx` website, the `docs` folder should be organised according to this layout for effective long term maintenance.

```
.
├── api                     # Automatically generated by docfx
├── apidoc                  # Place individual operator articles here (add link)
├── articles                # Place "Manual" articles here
├── bonsai                  # Docfx-tools submodule, see note below
├── images                  # Place images like screenshots here
├── workflow                # Store .bonsai workflow files here
├── favicon.ico             # Website bookmark logo
├── logo.svg                # Website logo
├── template                # See note below
│   └── public
│       ├── main.css
│       └── main.js
├── build.ps1
└── docfx.json
...
```

`bonsai` - this folder is where we place a submodule that we have created called [docfx-tools](https://github.com/bonsai-rx/docfx-tools). This submodule contains scripts for automating image export from Bonsai workflows and patches the `docfx` CSS templates to add workflow containers. To add it, run:

```powershell
git submodule add https://github.com/bonsai-rx/docfx-tools bonsai
```
If the `bonsai` folder doesnt contain any files, run 

```powershell
git submodule update --init
```


6) Copy over these folders/files from a repo that has been recently updated into the root folder of the repo. Amend the files as necessary. 

```markdown
- .gitignore file - this needs to be updated to ignore workflow files (i.e. .bonsai packages env).
```

7) Copy over these folders/files from a repo that has been recently updated into the "docs" folder.

```markdown
- docs/.gitignore file - filters out the _site folder that is generated during local preview.
- docs/workflows/.gitignore file - ignores bonsai layout files and svg files.
- docs/build.ps1 file - script  used to export images for sample workflows.
    - amend the line in the file to the new package name and source location.
- docs/template/public folder- contains main.css and main.js which patches in `docfx-tools`.
    - amend main.js to change the github link to the current repository.
```


### Configuring docfx

To fully utilize docfx, we have to modify the `docfx.json` file in the `docs` folder, which hosts the configuration options for the website. There are many possible configuration options that can be changed in the `docfx.json`, if in doubt refer to the [docfx documentation](https://dotnet.github.io/docfx/) or a Bonsai package repository that has been recently updated (for instance https://bonsai-rx.org/machinelearning/). 


1) Add additional files/folders that are to be used in the doc in the `resource` attribute.

```yml
"build": {
    "resource": {
        "files": [
            "logo.svg",
            "favicon.ico",
            "images/**",
            "workflows/**"
        ]
    }
}
```

2) Modify the `template` attribute to use the modern template and apply the `docfx-tools` custom templates to enable workflow containers.

```yml
"template": [
    "default",
    "modern",
    "bonsai/template",
    "template"
]
```

3) Change PackageName and github link to the repo being worked on and add footer information to the `globalMetadata` attribute.

```yml
"globalMetadata": {
    "_appName": "Bonsai - PackageName",
    "_appTitle": "Bonsai.PackageName",
    "_appFooter": "&copy; 2024 Bonsai Foundation CIC and Contributors. Made with <a href=\"https://dotnet.github.io/docfx\">docfx</a>",
    "_gitContribute": {
        "repo": "https://github.com/bonsai-rx/PackageName",
        "branch": "main",
        "apiSpecFolder": "apidoc"
    }
}
```
4) Enable additional markdig (the default DocFX markdown processor) extensions.

```yml
"build": {
    "markdownEngineProperties": {
        "markdigExtensions": [
        "attributes",
        "customcontainers"
        ]
    }
}
```

5) Add a `xref` attribute to cross reference operators and properties across the different Bonsai docs websites.

```yml
"build": {
    "xref": [
        "https://bonsai-rx.org/docs/xrefmap.yml",
        "https://horizongir.github.io/reactive/xrefmap.yml"
    ]
}
```


Optional:

1) [Filtering Operators](https://dotnet.github.io/docfx/docs/dotnet-api-docs.html#filter-apis) - Sometimes in the process of upgrading packages we want to avoid documenting operators that are no longer supported (but are still included for compatibility purposes for old workflows). You can also hide private classes that are not supposed to be shown to the end user. To do so we can add the `filter` attribute to `docfx.json` to filter out nodes in the package.

```yml
"metadata": [
    {
        "filter": "filter.yml"
    }
]
```

Make a file called `filter.yml` with content such as below and place in the `docs` directory. 

```yml
apiRules:
- exclude:
    hasAttribute:
      uid: System.ObsoleteAttribute
```

Finally, exclude `filter.yml` from being included in the building of content.

```yml
"build": {
    "content": [
        {
        "exclude": [
            "_site/**",
            "filter.yml"
        ]
        }
    ]
}
```

Add the `overwrite` attribute to enable individual operator articles stored in the `apidocs` folder to be included in articles and API docs.

```yml
"build": {
    "overwrite": [
      {
        "files": [
          "apidoc/**.md"
        ],
        "exclude": [
          "obj/**",
          "_site/**"
        ]
      }
    ],
}
```
## Testing Unpublished Packages
To write documentation for new packages or releases that have not been published to the community, test them in Visual Studio. 
Adapted from https://bonsai-rx.org/docs/articles/create-package.html.

1) Install [Visual Studio](https://www.visualstudio.com/) (the community edition can be installed for free).
2) Install Bonsai VS Extensions. Assuming Bonsai is already installed, from the Windows Start Menu, search for the "Install Bonsai VS Extensions" shortcut and run it.
3) In Visual Studio, open `src/PackageName.sln` in the repo.
4) Press F5 to open the Bonsai editor with the new package added. 
5) From here, you can make Bonsai workflows and save them as per normal.

## Publishing to Github Pages

Although this step is not necessary, it can be helpful if you want to check how your edits look online if the local preview is not working.

1) Setup a new branch called `gh-pages` on your fork of the repository.
2) Go to your repo settings -> `Pages` -> `Build and deployment` - under `Source` select `Deploy from a branch` and make sure `gh-pages` is selected.
3) Commit your edits and push to the `main` branch of your repo fork. 
4) Under the `Actions` tab of your github repo, trigger the `Build docs` workflow manually with the `Run workflow` button. This will build the docs site on the `gh-pages` branch.
5) Once the `Build docs` workflow has been completed, the `pages-build-deployment` workflow will run and publish your forked repo automatically.
7) The URL for the site can be found in your `Pages` section of your repo settings.


## Docfx Troubleshooting
> [!NOTE]  
> Occasionally, we run into weird bugs with the local preview. Check if the error persists by [publishing your fork online](#publishing-to-github-pages)